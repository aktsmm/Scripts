# Azure 全リソースグループ削除スクリプト v3

## 概要

このスクリプトは、Azure サブスクリプション内の**全リソースグループとその中のリソースを削除**する PowerShell スクリプトです。  
特に、**Azure Firewall など依存関係を持つリソースの削除順序**や、**削除待機処理**、**リトライ処理**も組み込まれており、安全かつ確実なリソース削除が可能です。

## 🚀 AzDeleteAllAzureResources2 からの進化点

### 主な新機能: **リソースロック自動削除オプション**

**Version 2 の制限：**

- リソースグループにロックがかかっている場合は、**問答無用でスキップ**されました
- ロックを削除したい場合は、手動で Azure Portal や CLI で削除してから再実行する必要がありました

**Version 3 では以下の機能が追加されました：**

1. **実行前のロック検出と警告表示**

   - スクリプト実行前に全リソースグループのロック状態を事前チェック
   - ロックがかかっているリソースグループを黄色でリスト表示

2. **ロック削除オプションの選択**

   - ユーザーに「ロックを削除して削除を実行するか？」を確認
   - `Yes` を選択すると、ロックを自動削除してからリソースグループを削除
   - `No` を選択すると、従来通りロック付きリソースグループをスキップ

3. **ロック削除の安全処理**
   - ロック削除失敗時は、そのリソースグループをスキップして処理続行
   - ロック削除の成功/失敗を視覚的に表示（✅/❌）

### 進化の比較表

| 機能               | Version 2                | Version 3 (本バージョン)            |
| :----------------- | :----------------------- | :---------------------------------- |
| ロック検出         | 削除時に検出してスキップ | **実行前に事前検出・リスト表示** ✨ |
| ロック付き RG 処理 | スキップのみ             | **ユーザー選択で自動削除可能** ✨   |
| ロック削除失敗時   | -                        | **エラー表示してスキップ続行** ✨   |
| Firewall 待機改善  | ✅ 実装済み              | ✅ 継続実装                         |
| リトライ機構       | ✅ 実装済み              | ✅ 継続実装                         |
| 削除完了待機       | ✅ 実装済み              | ✅ 継続実装                         |

---

## 特徴

- ✅ **リソースロック自動削除オプション**（Version 3 の新機能！）
- ✅ Azure Firewall や NSG など、削除に手間がかかるリソースへの特別対応
- ✅ リソースグループ削除後の**削除完了待機**機能
- ✅ 削除失敗時の**リトライ機構**搭載（2 回実行）
- ✅ ユーザーによる**確認プロンプト**で誤操作防止
- ✅ 進捗を**カラー付きで出力**（視認性向上）

## 動作環境

- **PowerShell 5.1 以上**
- **Azure PowerShell モジュール (Az モジュール)**
- 実行ユーザーは、対象リソースグループに対する**削除権限**とロック管理権限が必要です。

## 処理の流れ

### 1. 事前チェックフェーズ

1. Azure へログイン（未ログイン時のみ）
2. サブスクリプション情報を表示
3. **🆕 全リソースグループのロック状態を事前確認**
4. **🆕 ロックがある場合は警告リストを表示**

### 2. ユーザー確認フェーズ

5. 実行前にサブスクリプション削除確認プロンプト (`Yes` 入力時のみ続行)
6. **🆕 ロック削除オプションの選択プロンプト**
   - `Yes`: ロックを自動削除してから削除実行
   - `No`: ロック付きリソースグループはスキップ

### 3. 削除実行フェーズ（1 回目）

7. 各リソースグループについて以下を実施:
   - **🆕 ロック削除が選択されている場合、先にロックを削除**
   - リソースグループが削除中でないか確認
   - リソースごとの削除順序に従ってリソース削除
     - 優先順: VM → NIC → Public IP → NSG → Firewall → LB → VNET
     - 特別処理：
       - NSG のサブネット解除
       - Firewall の Public IP デタッチ + 更新完了待機（最大 2 回リトライ）
   - リソースグループ削除
   - 削除完了待機（最大約 100 秒）

### 4. リトライフェーズ（2 回目）

8. 削除失敗や削除中だったリソースグループに対して再度削除実行
9. 全削除完了メッセージ表示

---

## 注意事項

⚠️ **本スクリプトは非常に破壊的な操作**を行います。  
必ず対象サブスクリプションと削除対象リソースを事前に確認してください。

- **Version 3 では、ロックを削除する権限が必要**です
- 削除処理は時間がかかる場合があります（特に Azure Firewall）
- ロック削除に失敗した場合は、そのリソースグループはスキップされます

---

## 使い方

### 1. スクリプト保存

拡張子 `.ps1` のファイルに保存します（例: `DeleteAllAzureResources3.ps1`）。

### 2. 実行

```powershell
# 必ず管理者権限でPowerShellを起動
.\DeleteAllAzureResources3.ps1
```

### 3. 実行時の画面例

```
Tenant ID        : xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Subscription ID  : yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy
Subscription Name: My Azure Subscription

リソースロックの確認中...

⚠️ 以下のリソースグループにロックがかかっています:
  - rg-production
  - rg-critical-data

このサブスクリプションで本当にリソース削除を実行しますか？ (Yes/No): Yes

ロックがかかっているリソースグループのロックを削除して削除を実行しますか？ (Yes/No): Yes
✅ ロックを削除してから削除を実行します。

▶ リソースグループ削除を開始します...

Checking resource group: rg-production ...
🔓 Removing locks from resource group 'rg-production'...
  ✅ Lock removed: DoNotDeleteLock
✅ No lock detected. Proceeding with resource deletion in 'rg-production'...
...
```

---

## よくある質問 (FAQ)

| 質問                                               | 回答                                                                                                                                                                                     |
| :------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Version 2 との違いは？                             | **Version 2 はロック付き RG を問答無用でスキップ**していましたが、**Version 3 ではロックを自動削除するか選択できる**ようになりました。これにより手動でロックを外す手間が不要になります。 |
| ロックを削除したくない場合は？                     | ロック削除確認プロンプトで `No` と入力すれば、Version 2 と同じようにロック付き RG はスキップされます。                                                                                   |
| Public IP が Firewall に紐づいていて削除できない！ | 自動で Firewall の IP 構成から解除 → 更新します（Version 2 から継続）                                                                                                                    |
| Firewall 更新に失敗したら？                        | リトライ処理やスキップ処理により続行します（Version 2 から継続）                                                                                                                         |
| ロック削除に失敗したら？                           | エラーメッセージを表示し、そのリソースグループをスキップして処理を続行します                                                                                                             |
| 削除中で止まっているリソースグループは？           | リトライフェーズで再度削除を試みます（Version 2 から継続）                                                                                                                               |

---

## 免責事項

このスクリプトの使用により発生したいかなる損害についても、作者は責任を負いません。  
**必ず事前にバックアップやテストを行った上で使用してください。**

---

## バージョン履歴

### Version 3 (2025/10/08) - 本バージョン

- ✨ **リソースロック自動削除機能を追加**
- 実行前にロック状態を事前検出して表示
- ユーザー選択でロックを自動削除可能に

### Version 2 (2025/04/28)

- Firewall 待機処理の改善
- リトライ機構の実装
- 削除完了待機機能の追加

---

## 作者

- 作成者: Yamapan
- 最終更新日: 2025/10/08
