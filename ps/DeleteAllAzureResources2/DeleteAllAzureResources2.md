# Azure 全リソースグループ削除スクリプト

## 概要
このスクリプトは、Azure サブスクリプション内の**全リソースグループとその中のリソースを削除**するPowerShellスクリプトです。  
特に、**Azure Firewall など依存関係を持つリソースの削除順序**や、**削除待機処理**、**リトライ処理**も組み込まれており、安全かつ確実なリソース削除が可能です。

## 特徴
- Azure Firewall や NSG など、削除に手間がかかるリソースへの特別対応
- リソースグループ削除後の**削除完了待機**機能
- 削除失敗時の**リトライ機構**搭載
- ユーザーによる**確認プロンプト**で誤操作防止
- 進捗を**カラー付きで出力**

## 動作環境
- **PowerShell 5.1 以上**
- **Azure PowerShell モジュール (Az モジュール)**
- 実行ユーザーは、対象リソースグループに対する**削除権限**が必要です。

## 処理の流れ
1. Azureへログイン（未ログイン時のみ）
2. サブスクリプション情報を表示
3. 実行前にユーザー確認プロンプト (`Yes` 入力時のみ続行)
4. 各リソースグループについて以下を実施:
   - ロックされていないか確認
   - リソースごとの削除順序に従ってリソース削除
     - 優先順: VM → NIC → Public IP → NSG → Firewall → LB → VNET
     - 特別処理：
       - NSG のサブネット解除
       - Firewall の Public IP デタッチ + 更新完了待機
   - リソースグループ削除
   - 削除完了待機（最大約100秒）
5. リトライフェーズ実施（削除失敗や削除中だったものに再トライ）
6. 全削除完了メッセージ表示

## 注意事項
- **本スクリプトは非常に破壊的な操作**を行います。  
  必ず対象サブスクリプションと削除対象リソースを事前に確認してください。
- **ロックされたリソースグループ**はスキップされます。（ロック解除は自動では行いません）
- 削除処理は時間がかかる場合があります（特に Azure Firewall）。

## 使い方
### 1. スクリプト保存
拡張子 `.ps1` のファイルに保存します（例: `Remove-AllResourceGroups.ps1`）。

### 2. 実行
```powershell
# 必ず管理者権限でPowerShellを起動
.\Remove-AllResourceGroups.ps1
```

### 3. 確認プロンプト
```
このサブスクリプションで本当にリソース削除を実行しますか？ (Yes/No)
```
→ `Yes` と入力すると処理が開始されます。

## よくある質問 (FAQ)

| 質問 | 回答 |
|:----|:-----|
| Public IPがFirewallに紐づいていて削除できない！ | 自動でFirewallのIP構成から解除→更新します |
| Firewall更新に失敗したら？ | リトライ処理やスキップ処理により続行します |
| ロックされているリソースグループは？ | 削除せずスキップされます。手動で解除して再実行してください |
| 削除中で止まっているリソースグループは？ | リトライフェーズで再度削除を試みます |

## 免責事項
このスクリプトの使用により発生したいかなる損害についても、作者は責任を負いません。  
**必ず事前にバックアップやテストを行った上で使用してください。**

## 作者
- 作成者: Yamapan
- 更新日: 2025/04/28
